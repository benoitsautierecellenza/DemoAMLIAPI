{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "SOLUTION_LOGANALYTICSWORKSPACE_NAME": {
            "type": "string",
            "metadata": {
                "description": "name of the Log Analytics resource"
            }
        },
        "DATACOLLECTIONENDPOINTNETWORKACLS": {
            "type": "string",
            "allowedValues": [
                "Enabled",
                "Disabled",
                "SecuredByPerimeter"
            ]
        }
    },
    "variables": {
        "LOCATION": "[resourceGroup().location]",
        "DATACOLLECTIONRULE_API_VERSION": "2021-09-01-preview",
        "DATACOLLECTIONENDPOINTS_API_VERSION": "2021-04-01",
        "DATACOLLECTIONENDPOINTNAME": "[concat(parameters('ENVIRONMENT_NAME'),'-DCEACTIVITYLOG-',tolower(variables('LOCATION')))]",
        "DATACOLLECTIONRULENAME": "[concat(parameters('ENVIRONMENT_NAME'),'-DCRACTIVITYLOG-',tolower(variables('LOCATION')))]",
        "LOGANALYTICS_RESOURCEID": "[resourceId('microsoft.operationalinsights/workspaces', parameters('SOLUTION_LOGANALYTICSWORKSPACE_NAME'))]",
        "AMPLS_NAME": "[concat(parameters('ENVIRONMENT_NAME'),'ampls')]"
    },
    "resources": [
        {
            "comments": "Data Collection Endpoint resource",
            "type": "Microsoft.Insights/dataCollectionEndpoints",
            "apiVersion": "[variables('DATACOLLECTIONENDPOINTS_API_VERSION')]",
            "name": "[variables('DATACOLLECTIONENDPOINTNAME')]",
            "location": "[variables('LOCATION')]",
            "properties": {
                "networkAcls": {
                    "publicNetworkAccess": "[parameters('DATACOLLECTIONENDPOINTNETWORKACLS')]"
                }
            }
        },
        {
            "comments": "Pause script required to avoid issue when creating tge private link scope.",
            "type": "Microsoft.Resources/deploymentScripts",
            "apiVersion": "2020-10-01",
            "kind": "AzurePowerShell",
            "name": "DCEWaitsection1",
            "location": "[variables('LOCATION')]",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('DATACOLLECTIONENDPOINTNAME'))]"
            ],
            "properties": {
                "azPowerShellVersion": "3.0",
                "scriptContent": "start-sleep -Seconds 60",
                "cleanupPreference": "Always",
                "retentionInterval": "PT1H"
            }
        },
        {
            "comments": "Scoped resource for Data Collection Endpoint with AMPLS",
            "type": "Microsoft.Insights/privateLinkScopes/scopedResources",
            "apiVersion": "2021-07-01-preview",
            "name": "[concat(variables('AMPLS_NAME'), '/scoped-',variables('DATACOLLECTIONENDPOINTNAME'),'-3aad021b-8611-487b-8d96-97a53c77e01b')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deploymentScripts', 'DCEWaitsection1')]"
            ],
            "properties": {
                "linkedResourceId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('DATACOLLECTIONENDPOINTNAME'))]"
            }
        },
        {
            "comments": "Data Collection Rule resource (Dependency witth Data Collection Enpoint resource and Azure Log Anlytics Custom table)",
            "type": "Microsoft.Insights/dataCollectionRules",
            "apiVersion": "[variables('DATACOLLECTIONRULE_API_VERSION')]",
            "name": "[variables('DATACOLLECTIONRULENAME')]",
            "location": "[variables('LOCATION')]",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('DATACOLLECTIONENDPOINTNAME'))]",
                "[resourceId('Microsoft.Resources/deploymentScripts', 'DCEWaitsection1')]"
            ],
            "properties": {
                "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('DATACOLLECTIONENDPOINTNAME'))]",
                "streamDeclarations": {
                    "Custom-ActivityLog": {
                        "columns": [
                            {
                                "name": "Time",
                                "type": "datetime"
                            },
                            {
                                "name": "Message",
                                "type": "string"
                            },
                            {
                                "name": "Metadata",
                                "type": "dynamic"
                            }
                        ]
                    },
                    "Custom-MyTableRawData": {
                        "columns": [
                            {
                                "name": "Time",
                                "type": "datetime"
                            },
                            {
                                "name": "Computer",
                                "type": "string"
                            },
                            {
                                "name": "AdditionalContext",
                                "type": "string"
                            },
                            {
                                "name": "CounterName",
                                "type": "string"
                            },
                            {
                                "name": "CounterValue",
                                "type": "real"
                            }
                        ]
                    }
                },
                "destinations": {
                    "logAnalytics": [
                        {
                            "workspaceResourceId": "[variables('LOGANALYTICS_RESOURCEID')]",
                            "name": "logAnalyticsWorkspace"
                        }
                    ]
                },
                "dataFlows": [
                    {
                        "streams": [
                            "Custom-ActivityLog"
                        ],
                        "destinations": [
                            "logAnalyticsWorkspace"
                        ],
                        "transformKql": "source | extend TimeGenerated = Time | project TimeGenerated, Message, Metadata",
                        "outputStream": "Custom-Activitylog_CL"
                    },
                    {
                        "streams": [
                            "Custom-MyTableRawData"
                        ],
                        "destinations": [
                            "logAnalyticsWorkspace"
                        ],
                        "transformKql": "source | extend jsonContext = parse_json(AdditionalContext) | project TimeGenerated = Time, Computer, AdditionalContext = jsonContext, CounterName=tostring(jsonContext.CounterName), CounterValue=toreal(jsonContext.CounterValue)",
                        "outputStream": "Custom-MyTable_CL"
                    }
                ]
            }
        }
    ]
}